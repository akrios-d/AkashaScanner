@inherits RazorComponent
@page "/exports/paimonmoe"

@using Core.Exporters
@using Core.Importers
@using Core.DataFiles
@using Core.DataCollections
@inject IDataFileRepository<AchievementOutput> AchievementDataFiles
@inject IAchievementCollection AchievementCollections
@inject IDataFileRepository<CharacterOutput> CharacterDataFiles
@inject ICharacterCollection CharacterCollections
@inject IJSRuntime JS

<ExportLayout Enabled="@(SelectedAchievementFile is not null || !string.IsNullOrEmpty(ImportedContent))" OnSubmit="@ExportData">
    <div>
        <!-- Notice for users -->
        <div class="import__notice">
            If you use Paimon.moe not only for achievement tracking (e.g., wish counter),
            consider exporting data from
            <a class="link" href="https://paimon.moe/settings" target="_blank">Paimon.moe</a> first
            and importing it below to avoid overwriting your existing data.
        </div>

        <!-- File Import Form -->
        <form class="import__file">
            <InputFile id="@FileInputId" class="file-input" accept=".json" OnChange="@OnFileChange" />
            <button class="button button--outline reset-button" type="reset" @onclick="@ClearFile">Clear</button>
        </form>
    </div>

    <!-- Achievement and Character File Lists -->
    <DataFileList Title="Export Achievements"
                  FileList="@AchievementFileList"
                  @bind-Value="@SelectedAchievementFile" />

    <DataFileListOptional Title="Export Characters"
                          TitleNegative="Do not export characters"
                          FileList="@CharacterFileList"
                          @bind-Value="@SelectedCharacterFile" />
</ExportLayout>

@code {
    private const string FileInputId = "paimon-moe-exports-file-input";
    private long MaxFileSize { get; set; } = 10 * 1024 * 1024; // Default: 10 MB

    // Selected files and file lists
    private IDataFile<AchievementOutput>? SelectedAchievementFile { get; set; }
    private List<IDataFile<AchievementOutput>> AchievementFileList { get; set; } = new();
    private IDataFile<CharacterOutput>? SelectedCharacterFile { get; set; }
    private List<IDataFile<CharacterOutput>> CharacterFileList { get; set; } = new();
    private readonly ILogger Logger;

    // File import state
    private IBrowserFile? UploadedFile { get; set; }
    private string ImportedContent { get; set; } = string.Empty;

    /// <summary>
    /// Initialize the component and load available data files.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        InitializeFileLists();
        await base.OnInitializedAsync();
    }

    /// <summary>
    /// Clears the uploaded file state.
    /// </summary>
    private void ClearFile()
    {
        UploadedFile = null;
        ImportedContent = string.Empty;
    }

    /// <summary>
    /// Handles file change event, reading and storing the uploaded file content.
    /// </summary>
    private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        UploadedFile = e.File;
        if (UploadedFile is not null)
        {
            try
            {
                using var stream = UploadedFile.OpenReadStream(maxAllowedSize: MaxFileSize);
                using var reader = new StreamReader(stream, System.Text.Encoding.UTF8);
                ImportedContent = await reader.ReadToEndAsync();
                PaimonMoeImporter.Import(ImportedContent);
            }
            catch (Exception ex)
            {
                // Handle file read error (e.g., log or display error to user)
                Logger.LogError("Error reading file: {ex.Message}", ex.Message);
            }
        }
    }

    /// <summary>
    /// Exports the data to a JSON file, combining selected files and imported content.
    /// </summary>
    private async Task ExportData()
    {
        if (SelectedAchievementFile is not null)
        {
            try
            {
                if (PaimonMoeExporter.Export(out var result, SelectedAchievementFile, ImportedContent, SelectedCharacterFile))
                {
                    var timestamp = DateTime.Now.ToString("yyyy-MM-dd_HH-mm-ss");
                    await JS.InvokeAsync<bool>("__akasha_saveAsJson", $"paimon-moe_{timestamp}.json", result);
                }
            }
            catch (Exception ex)
            {
                // Handle export errors
                Logger.LogError("Export failed: {ex.Message}", ex.Message);
            }
        }
    }

    /// <summary>
    /// Loads and initializes file lists for achievements and characters.
    /// </summary>
    private void InitializeFileLists()
    {
        AchievementFileList = AchievementDataFiles.List();
        SelectedAchievementFile = AchievementFileList.FirstOrDefault();

        CharacterFileList = CharacterDataFiles.List();
        SelectedCharacterFile = CharacterFileList.FirstOrDefault();
    }
}
